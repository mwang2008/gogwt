<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
  <title>GoGWT </title>
  <link rel="stylesheet" href="html.css" type="text/css">
</head>

<body bgcolor="white" text="black" link="#0000FF" vlink="#840084"
alink="#0000FF">

<div class="book" lang="en">

<div class="titlepage">

<div>

<div>
<h1 class="title"><a name="d0e1"></a> Developing a GoGWT application</h1>
</div>

<div>

<div class="authorgroup">
<h2>Authors: <span class="author"><span class="surname">Michael
Wang</span></span></h2>
</div>
</div>

<div>
<p class="releaseinfo">1.0</p>
</div>

<div>

<div class="legalnotice">
Copies of this document may be made for your own use and for distribution to
others, provided that you do not charge any fee for such copies and further
provided that each copy contains this Copyright Notice, whether distributed in
print or electronically. </div>
</div>
</div>

<div>
</div>
<hr>
</div>

<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
  <dt><a href="#overview">Overview</a></dt>
    <dd><dl>
        <dt>1. <a href="#overview-whats-covered">What's covered</a></dt>
        <dt>2. <a href="#overview-prerequisite-software">Prerequisite
        software</a></dt>
        <dt>3. <a href="#overview-application-overview">The application we are
        building</a></dt>
      </dl>
    </dd>
  <dt>1. <a href="#part1">Basic Application and Environment Setup</a></dt>
    <dd><dl>
        <dt>1.1. <a href="#step1.1">Create the project directory
        structure</a></dt>
        <dt>1.2. <a href="#step1.2">Create 'index.jsp'</a></dt>
        <dt>1.3. <a href="#step1.3">Deploy the application to Tomcat</a></dt>
        <dt>1.4. <a href="#step1.4">Check the application works</a></dt>
        <dt>1.5. <a href="#step1.5">Download the Spring Framework</a></dt>
        <dt>1.6. <a href="#step1.6">Modify 'web.xml' in the 'WEB-INF'
        directory</a></dt>
        <dt>1.7. <a href="#step1.7">Copy libraries to 'WEB-INF/lib'</a></dt>
        <dt>1.8. <a href="#step1.8">Create the Controller</a></dt>
        <dt>1.9. <a href="#step1.9">Write a test for the Controller</a></dt>
        <dt>1.10. <a href="#step1.10">Create the View</a></dt>
        <dt>1.11. <a href="#step1.11">Compile and deploy the
        application</a></dt>
        <dt>1.12. <a href="#step1.12">Try out the application</a></dt>
        <dt>1.13. <a href="#d0e720">Summary</a></dt>
      </dl>
    </dd>
  <dt>2. <a href="#part2">Developing and Configuring the Views and the
  Controller</a></dt>
    <dd><dl>
        <dt>2.1. <a href="#step2.1">Configure JSTL and add JSP header
        file</a></dt>
        <dt>2.2. <a href="#step2.3">Improve the controller</a></dt>
        <dt>2.3. <a href="#step2.4">Decouple the view from the
        controller</a></dt>
        <dt>2.4. <a href="#d0e1077">Summary</a></dt>
      </dl>
    </dd>
  <dt>3. <a href="#part3">Developing the Business Logic</a></dt>
    <dd><dl>
        <dt>3.1. <a href="#step3.1">Review the business case of the Inventory
        Management System</a></dt>
        <dt>3.2. <a href="#step3.2">Add some classes for business logic</a></dt>
        <dt>3.3. <a href="#d0e1414">Summary</a></dt>
      </dl>
    </dd>
  <dt>4. <a href="#part4">Developing the Web Interface</a></dt>
    <dd><dl>
        <dt>4.1. <a href="#step4.1">Add reference to business logic in the
        controller</a></dt>
        <dt>4.2. <a href="#step4.2">Modify the view to display business data
        and add support for message bundle</a></dt>
        <dt>4.3. <a href="#step4.3">Add some test data to automatically
        populate some business objects</a></dt>
        <dt>4.4. <a href="#step4.4">Add the message bundle and a 'clean' target
        to 'build.xml'</a></dt>
        <dt>4.5. <a href="#step4.5">Adding a form</a></dt>
        <dt>4.6. <a href="#step4.6">Adding a form controller</a></dt>
        <dt>4.7. <a href="#step4.summary">Summary</a></dt>
      </dl>
    </dd>
  <dt>5. <a href="#part5">Implementing Database Persistence</a></dt>
    <dd><dl>
        <dt>5.1. <a href="#step5.1">Create database startup script</a></dt>
        <dt>5.2. <a href="#step5.2">Create table and test data scripts</a></dt>
        <dt>5.3. <a href="#step5.3">Add Ant tasks to run scripts and load test
        data</a></dt>
        <dt>5.4. <a href="#step5.4">Create a Data Access Object (DAO)
        implementation for JDBC</a></dt>
        <dt>5.5. <a href="#step5.5">Implement tests for JDBC DAO
        implementation</a></dt>
        <dt>5.6. <a href="#d0e2229">Summary</a></dt>
      </dl>
    </dd>
  <dt>6. <a href="#part6">Integrating the Web Application with the Persistence
  Layer</a></dt>
    <dd><dl>
        <dt>6.1. <a href="#step6.1">Modify service layer</a></dt>
        <dt>6.2. <a href="#step6.2">Fix the failing tests</a></dt>
        <dt>6.3. <a href="#step6.3">Create new application context for service
        layer configuration</a></dt>
        <dt>6.4. <a href="#step6.4">Add transaction and connection pool
        configuration to application context</a></dt>
        <dt>6.5. <a href="#step6.5">Final test of the complete
        application</a></dt>
        <dt>6.6. <a href="#step6.summary">Summary</a></dt>
      </dl>
    </dd>
  <dt>A. <a href="#build-scripts">Build Scripts</a></dt>
</dl>
</div>

<div class="preface" lang="en">

<div class="titlepage">

<div>

<div>
<h2 class="title"><a name="overview"></a>Prefex</h2>
</div>
</div>

<div>
<p>This document was written for developers who have worked with Java before
and want to start developing GWT application and/or who already work on GWT and
try to tune up the GWT application to run with high performance.</p>

<p>I have been working as a lead developer for the passed few years to design,
develop framework and implement business functions for the high traffic, high
volume and high competitive websites using GWT.</p>

<p>I try to turn on the reading of this book to be more hands on experience and
will provide examples, some with in details. I also will list few real world
difficulties/challenges regarding the design and implementation and how we
address those.</p>

<h2 class="title"><a name="introduction"></a>Few words of GWT </h2>

<p>Per Google definition <sup>[1]</sup>: Google Web Toolkit (GWT) is a
development toolkit for building and optimizing complex browser-based
applications. Its goal is to enable productive development of high-performance
web applications without the developer having to be an expert in browser
quirks, XMLHttpRequest, and JavaScript.</p>

<p>GWT makes it possible to create rich applicatoin easily. That means that the
application created by GWT may attrictive website users to stay longer on the
website and have more chance to relaize your website goal.</p>

<p>We performed split test which some percent users would use GWT website while
rest users would use old website, the result is more optimie for GWT. The
conversion rate of GWT website is high than the old site.</p>

<p>This is most promissing part I have experiecned, and it is the biggest
advantage of using GWT. And it is the motivation I write this document. </p>

<h4>Advantages:</h4>
<ol>
  <li>Increase conversion rate.</li>
  <li><span style="font-size: 8pt">Client code in Java, easy to
  debug.</span></li>
  <li><span style="font-size: 8pt">Object Oriented and well organized client
    code</span></li>
  <li><span style="font-size: 8pt">Remote Procedure Call Framework
  (AJAX)</span></li>
  <li><span style="font-size: 8pt">Abstracted from browser
  differences</span></li>
  <li><span style="font-size: 8pt">Javascript automatically optimized for
    performance with compilation</span></li>
  <li><span style="font-size: 8pt">Component Reusability with
  Inheritance</span></li>
</ol>

<h4>Disadvantages:</h4>
<ul>
  <li>Learning curve, it takes some time for a Java develop to master GWT.</li>
  <li>It is hard to train UI developer to use GWT as GWT put layout inside Java
    code. 
    <p>Recent uiBinder may solve this problem somewhat. </p>
  </li>
  <li>Hard to find experienced GWT developer. 
    <p>Reason one: there are few GWT developers in the market.</p>
    <p>Reason two: GWT app do need experienced developer in order to develop
    high performance website.</p>
  </li>
</ul>

<h4>Changllenges:</h4>
<ul>
  <li><em>GWT token</em>: can not get GWT token in server side</li>
  <li><em>SEO</em>: currently only Google officially provides a way to deal
    with SEO for the pages generated by GWT. </li>
  <li><em>Performance</em>: The first load is slow, as when user access GWT
    website, the user will retrive the first html page from server, then
    nocache.js wil be invoked from user broswer, then load bworser specific
    cached html Javascript. So use will wait for three server request instead
    of one to get first page.</li>
</ul>

<h4>Others</h4>
<ul>
  <li>Per GWT implementation, GWT nocache.js is parsed after other js, either
    third party js </li>
  <li>As GWT process data in user browser, it is easy to make mistake to push
    too much data to make it load slowly, or parse slowly.</li>
</ul>

<p></p>

<p><strong>Promissing </strong></p>
<ul>
  <li>Avoid session timed out problem as normal web application. With properly
    design/implementation, the uer input data can be retained in client side,
    so it can re-construct user activities. That will increase usebility and in
    turn increase conversion rate.</li>
  <li>Preload static data per permuation and load data on compile time. That
    will increase runtime response time. </li>
</ul>

<p></p>

<h2 class="title">Overview of GoGWT</h2>

<p>The website of <a href="www.gogwt.com">www.gogwt.com</a> is written for the
demo purpose of how to wirte GWT, it simulates real world application: user
searches for hotels after filling in the form with locatoin (address, airport
code, or geocde), then select specific hotel from hotel search list, after
fills in guest info (first name, last, email etc), the hotel will be reservated
and user will get reservation number. </p>

<p>It has three versions:</p>
<ul>
  <li>Spring MVC version</li>
  <li>GWT widget version</li>
  <li>GWT uiBInder, MPV version</li>
</ul>

<p>Within this doc, I will talk about how to build same application with three
different approaches, you will find the example how to use suggestion box,
google maps, tabs etc. </p>

<p>For GWT application, I will introduce new approache of using defer binding
to generate toekn manage. And will talk about of how to use hibernate and AOP.
</p>

<p>Also, I will talk about how to tune the performance. </p>

<h1>Spring MVC</h1>

<p>I will brifly talk about Spring MVC, one reason it is the nessary part of
GWT. I started to use Spring and Spring MVC few years ago. The basic concept of
using was from that time. SInce it is working well during the years in
production enviroment, I still use it. </p>

<p><img alt="" src="images/multi-tie.vsd"></p>

<p><img alt="" src="images/spring_mvc_layout.JPG" width="728" height="301"></p>

<p></p>

<p>Above diagram shows the layout used in GoGWT. For simplification. I remove
the middle layer of Spring or EBS layer normally used in enterprise
application.</p>

<p><img alt="ent" src="images/enterprise_layout.JPG" width="1021"
height="320"></p>

<p>GoGWT code is based on standard Maven structure, pom.xml is use to build and
deploy applicatoin. </p>

<p>Spring MVC config file booking-servlet.xml, located in
src/main/resources/conf, is defined in webapp/WEB-INF/web.xml</p>

<p><em>web.xml</em></p>
<pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;web-app version="2.4"
         xmlns="http://java.sun.com/xml/ns/j2ee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"&gt;

  &lt;servlet&gt;
   &lt;servlet-name&gt;booking&lt;/servlet-name&gt;
   &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
   &lt;init-param&gt;
      &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
      &lt;param-value&gt;/WEB-INF/classes/conf/booking-servlet.xml&lt;/param-value&gt;
   &lt;/init-param&gt;
   &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
  &lt;/servlet&gt;

&lt;/web-app&gt;</pre>

<p></p>

<p><em>booking-servlet.xml</em></p>
<pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:aop="http://www.springframework.org/schema/aop"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
  http://www.springframework.org/schema/beans/spring-beans-2.0.xsd http://www.springframework.org/schema/aop
  http://www.springframework.org/schema/aop/spring-aop-2.0.xsd"&gt;

   &lt;!-- ========================= IMPORTS ============================== --&gt;     
   &lt;!-- model bean --&gt;
   &lt;import resource="classpath:conf/domainService.xml"/&gt; 

   &lt;!-- dao bean --&gt;
   &lt;import resource="classpath:conf/daoService.xml"/&gt; 

   &lt;!-- scope beans: session, flash --&gt;
   &lt;import resource="classpath:conf/scopeBeans.xml"/&gt;

   &lt;!-- GWT RPC remote call section --&gt;
   &lt;import resource="classpath:conf/rpcConfig.xml"/&gt;

   &lt;!-- pipeline mapping --&gt;
   &lt;import resource="classpath:conf/pipeline.xml"/&gt;

   &lt;!-- ========================= BEAN DEFINITIONS ============================== --&gt;     
   &lt;!-- bean lookup service --&gt;
   &lt;bean class="com.gogwt.app.booking.utils.BeanLookupService"/&gt;

   &lt;!-- ========================= VALIDATOR ========================= --&gt;
   &lt;bean name="name=validator/reservation/SearchFormValidator"
          class="com.gogwt.app.booking.controllers.validation.SearchFormValidator"/&gt;
   &lt;bean name="name=validator/reservation/GuestInfoFormValidator"
          class="com.gogwt.app.booking.controllers.validation.GuestInfoFormValidator"/&gt;
  
  
   &lt;!-- ========================= INTERCEPTOR ========================= --&gt;
   &lt;bean name="Booking:name=interceptor/config/URLHandlerInterceptor"
           class="com.gogwt.app.booking.config.interceptor.URLHandlerInterceptor"&gt;
       &lt;property name="supportedLangRegion"&gt;
         &lt;map&gt;
           &lt;entry key="en-US"&gt;&lt;value&gt;US English&lt;/value&gt;&lt;/entry&gt;
           &lt;entry key="es-ES"&gt;&lt;value&gt;Español&lt;/value&gt;&lt;/entry&gt;     
         &lt;/map&gt;
       &lt;/property&gt;
       &lt;property name="controllerGWTConfigMap"&gt;
         &lt;map&gt;
           &lt;entry key="gwtreservation"&gt;&lt;value&gt;conf/gwt/ReservationProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
           &lt;entry key="mvpreservation"&gt;&lt;value&gt;conf/gwt/ReservationMVPProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
           &lt;entry key="mvphoteldetail"&gt;&lt;value&gt;conf/gwt/HotelDetailMVPProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
         &lt;/map&gt;
       &lt;/property&gt;     
    &lt;/bean&gt;

             
    &lt;!-- ========================= INTERNAL RESOURCE RESOLVER ========================= --&gt;
    &lt;bean name="localeResolver" class="com.gogwt.app.booking.config.resolver.BookLocaleResolver"&gt; 
       &lt;property name="defaultLocale"&gt;&lt;value&gt;en_US&lt;/value&gt;&lt;/property&gt;
    &lt;/bean&gt;

    &lt;!-- ========================= RESOURCE BUNDLE DEFINITIONS ========================= --&gt;
    &lt;bean name="messageSource" class="org.springframework.context.support.ResourceBundleMessageSource"&gt;
      &lt;property name="basenames"&gt;
       &lt;list&gt;
         &lt;value&gt;com.gogwt.app.booking.resources.i18n.view.LabelResources&lt;/value&gt;
         &lt;value&gt;com.gogwt.app.booking.resources.i18n.error.ErrorResources&lt;/value&gt;
         &lt;value&gt;com.gogwt.app.booking.resources.i18n.misc.MiscResources&lt;/value&gt;
       &lt;/list&gt;
     &lt;/property&gt;
    &lt;/bean&gt;
  
    &lt;!-- ========================= POPULATOR ========================= --&gt;
    &lt;bean name="name=populator/StatePopulator" class="com.gogwt.app.booking.populator.StatePopulator"/&gt;
    &lt;bean name="name=populator/TitlePopulator" class="com.gogwt.app.booking.populator.TitlePopulator"/&gt;
  
    &lt;!-- ========================= CONTROLLER DEFINITIONS ========================= --&gt;     
    &lt;bean name="name=controller/common/ErrorController"
        class="com.gogwt.app.booking.controllers.action.ErrorController"/&gt; 
    
    
    &lt;!-- HomeController" --&gt;
    &lt;bean name="name=controller/reservation/HomeController"
        class="com.gogwt.app.booking.controllers.HomePageController"/&gt; 

    &lt;!-- HotelSearchController --&gt;
    &lt;bean name="name=controller/reservation/HotelSearchController"
        class="com.gogwt.app.booking.controllers.action.HotelSearchController"&gt;    
      &lt;property name="bindOnNewForm"&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;
      &lt;property name="commandName"&gt;&lt;value&gt;searchFormBean&lt;/value&gt;&lt;/property&gt;
      &lt;property name="validator"&gt;&lt;ref bean="name=validator/reservation/SearchFormValidator"/&gt;&lt;/property&gt;
      &lt;property name="formView"&gt;&lt;value&gt;/reservation/search_form&lt;/value&gt;&lt;/property&gt;
      &lt;property name="successView"&gt;&lt;value&gt;searchresult&lt;/value&gt;&lt;/property&gt;  
    &lt;/bean&gt;   

    &lt;bean name="name=controller/reservation/HotelSearchResultController"
               class="com.gogwt.app.booking.controllers.action.HotelSearchResultController"/&gt; 
    
    &lt;bean name="name=controller/reservation/GuestInfoController"
               class="com.gogwt.app.booking.controllers.action.GuestInfoController"&gt;
      &lt;property name="populators"&gt;
         &lt;map&gt;
            &lt;entry key="statePopulator"&gt;&lt;ref bean="name=populator/StatePopulator"/&gt; &lt;/entry&gt;
            &lt;entry key="titlePopulator"&gt;&lt;ref bean="name=populator/TitlePopulator"/&gt; &lt;/entry&gt; 
         &lt;/map&gt;
      &lt;/property&gt;   
      &lt;property name="bindOnNewForm"&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;
      &lt;property name="commandName"&gt;&lt;value&gt;guestInfoFormBean&lt;/value&gt;&lt;/property&gt;
      &lt;property name="validator"&gt;&lt;ref bean="name=validator/reservation/GuestInfoFormValidator"/&gt;&lt;/property&gt;
      &lt;property name="formView"&gt;&lt;value&gt;/reservation/guest_info_form&lt;/value&gt;&lt;/property&gt;
      &lt;property name="successView"&gt;&lt;value&gt;confirmed&lt;/value&gt;&lt;/property&gt;         
    &lt;/bean&gt; 
    
    &lt;bean name="name=controller/reservation/ConfirmedController"
        class="com.gogwt.app.booking.controllers.action.ConfirmedController"/&gt; 
    &lt;bean name="name=controller/property/HotelDetailController"
        class="com.gogwt.app.booking.controllers.action.HotelDetailController"/&gt;


    &lt;!-- ========================= GWT CONTROLLER ========================= --&gt;
    &lt;bean name="name=controller/reservation/GWTHotelSearchController"
             class="com.gogwt.app.booking.controllers.action.gwt.GWTHotelSearchController"&gt;
         &lt;property name="controllerName"&gt;&lt;value&gt;gwtreservation&lt;/value&gt;&lt;/property&gt;
    &lt;/bean&gt;
    &lt;bean name="name=controller/reservation/GWTMVPHotelSearchController"
             class="com.gogwt.app.booking.controllers.action.gwt.GWTMVPHotelSearchController"&gt;
        &lt;property name="controllerName"&gt;&lt;value&gt;mvpreservation&lt;/value&gt;&lt;/property&gt;
    &lt;/bean&gt;
    &lt;bean name="name=controller/reservation/GWTHotelDetailController"
             class="com.gogwt.app.booking.controllers.action.gwt.GWTHotelDetailController"&gt;
        &lt;property name="controllerName"&gt;&lt;value&gt;mvphoteldetail&lt;/value&gt;&lt;/property&gt;
    &lt;/bean&gt;

    &lt;!-- ========================= URL MAPPING ========================= --&gt;
    &lt;bean name="urlMappingPart2" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"&gt;
       &lt;property name="interceptors"&gt;
         &lt;list&gt;
            &lt;ref bean="Booking:name=interceptor/config/URLHandlerInterceptor"/&gt;
         &lt;/list&gt;
       &lt;/property&gt; 

       &lt;property name="mappings"&gt;
           &lt;props&gt;
              &lt;prop key="/**/home/**/"&gt;name=controller/reservation/HomeController&lt;/prop&gt; 
              &lt;prop key="/**/hotelsearch/**/"&gt;name=controller/reservation/HotelSearchController&lt;/prop&gt;
              &lt;prop key="/**/searchresult/**/"&gt;name=controller/reservation/HotelSearchResultController&lt;/prop&gt;
              &lt;prop key="/**/guestinfo/**/"&gt;name=controller/reservation/GuestInfoController&lt;/prop&gt;
              &lt;prop key="/**/confirmed/**/"&gt;name=controller/reservation/ConfirmedController&lt;/prop&gt;
              &lt;prop key="/**/hoteldetail/**/"&gt;name=controller/property/HotelDetailController&lt;/prop&gt;      
              &lt;prop key="/**/gwtreservation/**/"&gt;name=controller/reservation/GWTHotelSearchController&lt;/prop&gt;
              &lt;prop key="/**/mvpreservation/**/"&gt;name=controller/reservation/GWTMVPHotelSearchController&lt;/prop&gt; 
              &lt;prop key="/**/mvphoteldetail/**/"&gt;name=controller/reservation/GWTHotelDetailController&lt;/prop&gt;        
              &lt;prop key="/**/errorPage/**/"&gt;name=controller/common/ErrorController&lt;/prop&gt;        
                   
           &lt;/props&gt;
       &lt;/property&gt;
     &lt;/bean&gt;
   
     &lt;bean name="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;
        &lt;property name="viewClass"&gt;&lt;value&gt;org.springframework.web.servlet.view.JstlView&lt;/value&gt;&lt;/property&gt;
        &lt;property name="prefix"&gt;&lt;value&gt;/jsp&lt;/value&gt;&lt;/property&gt;
        &lt;property name="suffix"&gt;&lt;value&gt;.jsp&lt;/value&gt;&lt;/property&gt;
    &lt;/bean&gt;
    
   
&lt;/beans&gt;
</pre>

<p></p>

<p><em><strong>Screen shots of Spring MVC GoGWT and explaination of the GoGWT
functions.</strong></em></p>

<p><strong>URL</strong>: http://www.gogwt.com/gwtbooking/en-us/hotelsearch</p>

<p><strong>Description</strong>: user fills in address and radius, then click
Find A Hotel button. GoGWT server will first find geocode with Google Geocode
service, then use that geocode to look at GoGWT database to find the hotels
with the radius around that specific geocode. If found, save result to session
with session manager, then redirect to searchresult page., else display error
message.</p>

<p>Hibernate is used to invoke with database call. </p>

<p><img alt="search" src="images/mvc_hotelsearch.jpg" width="1222"
height="446"></p>

<p><strong>URL:</strong> http://www.gogwt.com/gwtbooking/en-us/searchresult</p>

<p><strong>Description: </strong>Once hotels are found, Google map API is
applied to display hotels in Google Map. Also, hotel list is displayed under
Google Map. Once user selects specific hotel by clicking Reserve button, the
page will redirect to guestinfo page to get user's information. </p>

<p><span class="bold"><span class="bold"><img alt="seach result"
src="images/mvc_searchresult.jpg" width="1144" height="824"></span></span></p>

<p><strong>URL:</strong> http://www.gogwt.com/gwtbooking/en-us/guestinfo</p>

<p><strong>Description: </strong>Guest information is required in order to book
the hotel. Once user fills in all fields, and click Confirm Reservation Button,
GoGWT server will save data into database and redirect to next page.</p>

<p><img alt="guest info" src="images/mvc_guestinfo.jpg" width="1222"
height="580"></p>

<p><strong>URL:</strong> http://www.gogwt.com/gwtbooking/en-us/confirmed</p>

<p><strong>Description: </strong>Reservation number, Guest Info and Hotel
Information are displayed.</p>

<p><img alt="confirmed " src="images/mvc_confirmed.jpg" width="1222"
height="446"></p>

<p></p>

<h3><strong>Spring Form Controllers Work Flow</strong> </h3>

<p>This workflow describes how the Spring MVC Controller handles GET and POST
requests. For more information, refer to the Spring MVC documentation.</p>

<p><em>Get Request</em></p>

<p>The controller receives a request for a new form (typically a GET). Refer to
the com.gogwt.app.booking.controllers package for examples.</p>
<ul>
  <li>Calls to formBackingObject() by default. This method returns an instance
    of the commandClass that has been configured (see the properties the
    superclass exposes), but can also be overridden to e.g. retrieve an object
    from the database (that needs to be modified using the form).</li>
  <li>Call to initBinder() which allows you to register custom editors for
    certain fields (often properties of non-primitive or non-String types) of
    the command class. This will render appropriate Strings for those property
    values, e.g. locale-specific date strings.</li>
  <li>Only if bindOnNewForm is set to true, then ServletRequestDataBinder gets
    applied to populate the new form object with initial request parameters and
    the onBindOnNewForm(HttpServletRequest, Object, BindException) callback
    method is called. Note: any defined Validators are not applied at this
    point, to allow partial binding. However be aware that any Binder
    customizations applied via initBinder() (such as
    DataBinder.setRequiredFields(String[]) will still apply. As such, if using
    bindOnNewForm=true and initBinder() customizations are used to validate
    fields instead of using Validators, in the case that only some fields will
    be populated for the new form, there will potentially be some bind errors
    for missing fields in the errors object. Any view (JSP, etc.) that displays
    binder errors needs to be intelligent and for this case take into account
    whether it is displaying the initial form view or subsequent post results,
    skipping error display for the former.</li>
  <li>Call to showForm() to return a View that should be rendered (typically
    the view that renders the form). This method has to be implemented in
    subclasses.</li>
  <li>The showForm() implementation will call referenceData(), which you can
    implement to provide any relevant reference data you might need when
    editing a form (e.g. a List of Locale objects you're going to let the user
    select one from).</li>
  <li>Model gets exposed and view gets rendered, to let the user fill in the
    form.</li>
</ul>

<p><em>POST Request</em></p>

<p>The controller receives a form submission (typically a POST). Refer to the
com.gogwt.app.booking.controllers package for examples.</p>
<ul>
  <li>To use a different way of detecting a form submission, override the
    isFormSubmission method.</li>
  <li>If sessionForm is not set, formBackingObject() is called to retrieve a
    form object. Otherwise, the controller tries to find the command object
    which is already bound in the session. If it cannot find the object, it
    does a call to handleInvalidSubmit which - by default - tries to create a
    new form object and resubmit the form.</li>
  <li>The ServletRequestDataBinder gets applied to populate the form object
    with current request parameters.</li>
  <li>Call to onBind(HttpServletRequest, Object, Errors) which allows you to do
    custom processing after binding but before validation (e.g. to manually
    bind request parameters to bean properties, to be seen by the
  Validator).</li>
  <li>If validateOnBinding is set, a registered Validator will be invoked. The
    Validator will check the form object properties, and register corresponding
    errors via the given Errors object.</li>
  <li>Call to onBindAndValidate() which allows you to do custom processing
    after binding and validation (e.g. to manually bind request parameters, and
    to validate them outside a Validator).</li>
  <li>Call to processFormSubmission() to process the submission. It inspects
    the Errors object to see if any errors have occurred during binding and
    validation.</li>
  <li>If errors occured, the controller will return the configured formView,
    showing the form again (possibly rendering according error messages).</li>
  <li>If isFormChangeRequest is overridden and returns true for the given
    request, the controller will return the formView too. In that case, the
    controller will also suppress validation. Before returning the formView,
    the controller will invoke
    onFormChange(javax.servlet.http.HttpServletRequest,
    javax.servlet.http.HttpServletResponse, java.lang.Object,
    org.springframework.validation.BindException), giving sub-classes a chance
    to make modification to the command object. This is intended for requests
    that change the structure of the form, which should not cause validation
    and show the form in any case.</li>
  <li>initBinder() customizations are used to vny Binder customizations applied
    via initBinder() (such as DataBinder.setRequiredFields(String[])
  wdefined</li>
  <li>If no errors occurred, the controller will call onSubmit using all
    parameters, which in case of the default implementation delegates to
    onSubmit with just the command object. The default implementation of the
    latter method will return the configured successView. Consider implementing
    doSubmitAction(java.lang.Object) doSubmitAction for simply performing a
    submit action and rendering the success view.</li>
</ul>

<p>Form controllers are configured in the booking-servlet.xml definition. Refer
to the booking-servlet.xml documentation in the bean definition section for
more information.</p>

<h3>Spring MVC components:</h3>

<p>Following, I will list some components of Spring MVC and give example of how
to use them.</p>

<h4>Bean Creation</h4>

<p>Spring define beans in xml file. GoGWT Spring configuration can be found in
\src\main\resources\conf</p>

<p>Spring IOC or dependency injection mainly through Constructor Injection,
Setter Injection. For most case, I use setter injection with no particular
reason. However for this document, I change my code ofURLHandlerInterceptor to
use construction. So URLHandlerInterceptor has both constuction and setter
injection. </p>

<p>booking-servlet.xml bean definition:</p>
<pre class="programlisting"><span style="font-size: 10pt">   &lt;!-- ========================= INTERCEPTOR ========================= --&gt;
   &lt;bean name="Booking:name=interceptor/config/URLHandlerInterceptor" class="com.gogwt.app.booking.config.interceptor.URLHandlerInterceptor"&gt;
       &lt;property name="supportedLangRegion"&gt;
         &lt;map&gt;
           &lt;entry key="en-US"&gt;&lt;value&gt;US English&lt;/value&gt;&lt;/entry&gt;
           &lt;entry key="es-ES"&gt;&lt;value&gt;Español&lt;/value&gt;&lt;/entry&gt;     
         &lt;/map&gt;
       &lt;/property&gt;
       
       <strong>&lt;constructor-arg index="0"&gt;
         &lt;map&gt;
            &lt;entry key="gwtreservation"&gt;&lt;value&gt;conf/gwt/ReservationProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
            &lt;entry key="mvpreservation"&gt;&lt;value&gt;conf/gwt/ReservationMVPProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
            &lt;entry key="mvphoteldetail"&gt;&lt;value&gt;conf/gwt/HotelDetailMVPProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
         &lt;/map&gt;
       &lt;/constructor-arg&gt; 
</strong>       
       &lt;!-- repleace with above contruction IOC
       &lt;property name="controllerGWTConfigMap"&gt;
         &lt;map&gt;
           &lt;entry key="gwtreservation"&gt;&lt;value&gt;conf/gwt/ReservationProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
           &lt;entry key="mvpreservation"&gt;&lt;value&gt;conf/gwt/ReservationMVPProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
           &lt;entry key="mvphoteldetail"&gt;&lt;value&gt;conf/gwt/HotelDetailMVPProcessConfig.xml&lt;/value&gt;&lt;/entry&gt;
         &lt;/map&gt;
       &lt;/property&gt;     
       --&gt;
    &lt;/bean&gt;</span></pre>

<h4>Bean Instance Retrieval</h4>

<p>Bean instance is created inside application context. There are two ways to
get bean reference:</p>
<ol>
  <li>Through bean xml definition, bean is injected with IOC.</li>
  <li>Through bean lookup. </li>
</ol>

<p>BeanLookupService.java is convinence class to lookup bean with bean name.</p>

<p><em>BeanLookupService</em></p>
<pre class="programlisting"><span style="font-size: 10pt">public class BeanLookupService extends ApplicationObjectSupport {
   ...
   public static Object getBean(final String beanName) throws NoSuchBeanDefinitionException {

      if (mApplicationContext == null) {
         return null;
      }

     return mApplicationContext.getBean(beanName);
   }
   ...
}</span></pre>

<p>Example of using bean lookup, GoGWT has session bean scope
ReservationSessionManager which contains value of user input such as location,
radius, geocode, selected hotel etc. It is not convenience to inject to each
class with ReservationSessionManager. Use bean lookup is applied when
ReservationSessionManager is used.</p>

<p><em>SessionBeanLookupService</em></p>
<pre class="programlisting"><span style="font-size: 10pt">public class SessionBeanLookupService {
 private static final String RESERVATION_MANAGER = "reservationSessionManager";
 
  public static ReservationSessionManager getReservationSessionManager()
  {
    return (ReservationSessionManager)BeanLookupService.getBean(RESERVATION_MANAGER );
  }
}</span></pre>

<p><strong>Interceptors</strong></p>

<p>Spring MVC has the concept of interceptors that allow requests to the site
to be incepted. A Spring interceptor will intercept every request and perform
the required functions for the app. For more information, refer to the Spring
web site
(_http://static.springframework.org/spring/docs/2.0.x/reference/index.html_).
</p>

<p>GoGWT URLHandlerInterceptor config for Spring MVC app.</p>
<pre class="programlisting">  <span style="font-size: 10pt">&lt;!-- ========================= INTERCEPTOR ========================= --&gt;
   &lt;bean name="Booking:name=interceptor/config/URLHandlerInterceptor"
           class="com.gogwt.app.booking.config.interceptor.URLHandlerInterceptor"&gt;
       &lt;property name="supportedLangRegion"&gt;
         &lt;map&gt;
           &lt;entry key="en-US"&gt;&lt;value&gt;US English&lt;/value&gt;&lt;/entry&gt;
           &lt;entry key="es-ES"&gt;&lt;value&gt;Español&lt;/value&gt;&lt;/entry&gt;     
         &lt;/map&gt;
       &lt;/property&gt;
   &lt;/bean&gt;</span>
 
  <span style="font-size: 10pt">&lt;!-- ========================= URL MAPPING ========================= --&gt;
   &lt;bean name="urlMappingPart2" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"&gt;
       &lt;property name="interceptors"&gt;
         &lt;list&gt;
           &lt;ref bean="Booking:name=interceptor/config/URLHandlerInterceptor"/&gt;
         &lt;/list&gt;
       &lt;/property&gt; 

       &lt;property name="mappings"&gt;
           &lt;props&gt;
              &lt;prop key="/**/hotelsearch/**/"&gt;name=controller/reservation/HotelSearchController&lt;/prop&gt;
              &lt;prop key="/**/searchresult/**/"&gt;name=controller/reservation/HotelSearchResultController&lt;/prop&gt;
              &lt;prop key="/**/guestinfo/**/"&gt;name=controller/reservation/GuestInfoController&lt;/prop&gt;
              &lt;prop key="/**/confirmed/**/"&gt;name=controller/reservation/ConfirmedController&lt;/prop&gt;
                ...
           &lt;/props&gt;
       &lt;/property&gt;
   &lt;/bean&gt;</span></pre>

<p></p>

<p>The GoGWT URLHandlerInterceptor will initialize and set any request
attributes used by the application. The current functionality in the
interceptor is the following:</p>
<ul>
  <li>Parse the URL to get attributes of languageId, countryId, controllerName,
    contextPath, hotelId (if apply) etc mapping element and sets it as a
    request attribute with name "env". JSP will use JSTL of "env" varialbe to
    render the page.</li>
  <li>Get supportedLangRegion for support languages, currently GoGWT supports
    two languages en and es, </li>
</ul>

<h4><strong>Multi-Language supports</strong></h4>

<p>Spring MVC supports multiplanguage with resouce bundle for each langauge,
GoGWT use following config to handle language switches. </p>

<p>Locale Resolver </p>

<p>The locale resolver is used to determine the locale of the user. The locale
is obtained by parsing the URL to obtain the country and language. Using the
country and language, the locale is built and set into the request. The locale
resolver class is com.gogwt.app.booking.config.resolver.BookLocaleResolver.</p>

<p>Spring MVC will access the resolveLocale() method on every request. The
resolveLocale()method will build the locale by obtaining the country and
language attributes from the request. If the country or language is not
available in the request, the default locale is used.</p>

<p>The locale resolver is configured in the application context with the
following:</p>

<p>GoGWT URLHandlerInterceptor config for Spring MVC app.</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt">    &lt;!-- ========================= INTERNAL RESOURCE RESOLVER ========================= --&gt;
    &lt;bean name="<strong>localeResolver</strong>" class="com.gogwt.app.booking.config.resolver.BookLocaleResolver"&gt; 
       &lt;property name="defaultLocale"&gt;&lt;value&gt;en_US&lt;/value&gt;&lt;/property&gt;
    &lt;/bean&gt;

    &lt;!-- ========================= RESOURCE BUNDLE DEFINITIONS ========================= --&gt;
    &lt;bean name="<strong>messageSource</strong>" class="org.springframework.context.support.ResourceBundleMessageSource"&gt;
      &lt;property name="basenames"&gt;
       &lt;list&gt;
         &lt;value&gt;com.gogwt.app.booking.resources.i18n.view.LabelResources&lt;/value&gt;
         &lt;value&gt;com.gogwt.app.booking.resources.i18n.error.ErrorResources&lt;/value&gt;
         &lt;value&gt;com.gogwt.app.booking.resources.i18n.misc.MiscResources&lt;/value&gt;
       &lt;/list&gt;
     &lt;/property&gt;
    &lt;/bean&gt;</span></span></span></pre>

<p>Where the default locale is set to en_US.</p>

<p>To access the locale within the appli cation:</p>

<p><code><em>Java:</em></code> MessageUtils has static methods with name of
getMessage(...) to get langauge specific message from resouce bundle. See
MessageUtils.java for detail. </p>

<p><em><code>JSP</code></em>: JSP uses JSTL to access language specific message
from resource bundle, for example, see &lt;fmt:message key='label.radius'/&gt;
in search_form.jsp</p>

<h4><strong>Populators</strong></h4>

<p>Populators are used to pre-popuate items such as State, Title etc. The
following steps to used to create a populator:</p>

<p>The populator class should implement the
com.gogwt.app.booking.populator.Populator interface.</p>

<p>Take guestinfo page as example, this page contains two dropdown list, title
and state. </p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 11pt">    &lt;!-- ========================= POPULATOR ========================= --&gt;
    &lt;bean name="name=populator/StatePopulator" class="com.gogwt.app.booking.populator.StatePopulator"/&gt;
    &lt;bean name="name=populator/TitlePopulator" class="com.gogwt.app.booking.populator.TitlePopulator"/&gt;

    &lt;!-- ========================= CONTROLLER ========================= --&gt;
    &lt;bean name="name=controller/reservation/GuestInfoController"
           class="com.gogwt.app.booking.controllers.action.GuestInfoController"&gt;
       &lt;property name="populators"&gt;
         <strong>&lt;map&gt;
           &lt;entry key="statePopulator"&gt;&lt;ref bean="name=populator/StatePopulator"/&gt; &lt;/entry&gt;
           &lt;entry key="titlePopulator"&gt;&lt;ref bean="name=populator/TitlePopulator"/&gt; &lt;/entry&gt; 
         &lt;/map&gt;</strong>
      &lt;/property&gt;    
      &lt;property name="bindOnNewForm"&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;
      &lt;property name="commandName"&gt;&lt;value&gt;guestInfoFormBean&lt;/value&gt;&lt;/property&gt;
      &lt;property name="validator"&gt;&lt;ref bean="name=validator/reservation/GuestInfoFormValidator"/&gt;&lt;/property&gt;
      &lt;property name="formView"&gt;&lt;value&gt;/reservation/guest_info_form&lt;/value&gt;&lt;/property&gt;
      &lt;property name="successView"&gt;&lt;value&gt;confirmed&lt;/value&gt;&lt;/property&gt;  
       
    &lt;/bean&gt; </span></span></pre>

<p>StatePopulator will call Database through Hibernate to retrieve all for US
state list for specific language. </p>

<p>In GuestInfoController setting, it contains two pupolators, one is
StatePopulator and one is TitlePopulator. The extended class of
BaseAbstractController overrides referenceData method which will be got call
when the page is rendered. Within referenceData method, iteration will be
performed to invoke each populator defiend in config file and set to request
value with populator key. </p>

<p>In JSP, those populators would be retrived with Spring form taglib
&lt;form:options ,,&gt; refer, guest_info_form.jsp for detail</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 11pt">   &lt;form:form commandName="guestInfoFormBean" action="${env.prefix}/guestinfo" method="post"&gt;
      ...
      &lt;form:select id="stateId" path="stateId"&gt;
         &lt;form:option value=""&gt;-- &lt;fmt:message key='Label.state'/&gt; --&lt;/form:option&gt;
         <strong>&lt;form:options items="${statePopulator}" itemLabel="display" itemValue="code"/&gt;</strong>
      &lt;/form:select&gt;
     ...
  &lt;/form:form&gt;</span></span></pre>

<p>Where display and code are the attributes of PopulatorItem.java </p>

<h4><strong>Validators</strong></h4>

<p>Spring provides a Validator interface that can used to validate objects. The
Validator interface works by creating a validator class and binding the
validator to the controller in the bean defintion. When the controller submits
a form, the validator is called to validate the user input. The following is an
example of the validator XML defintion:</p>

<p>Take guestinfo page as example, the form has set validator to be referenced
with name=validator/reservation/GuestInfoFormValidator.</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 11pt">    &lt;!-- ========================= VALIDATOR ========================= --&gt;
    &lt;bean name="name=validator/reservation/GuestInfoFormValidator"
            class="com.gogwt.app.booking.controllers.validation.GuestInfoFormValidator"/&gt;

    &lt;!-- ========================= CONTROLLER ========================= --&gt;
    &lt;bean name="name=controller/reservation/GuestInfoController"
           class="com.gogwt.app.booking.controllers.action.GuestInfoController"&gt;
       &lt;property name="populators"&gt;
         &lt;map&gt;
           &lt;entry key="statePopulator"&gt;&lt;ref bean="name=populator/StatePopulator"/&gt; &lt;/entry&gt;
           &lt;entry key="titlePopulator"&gt;&lt;ref bean="name=populator/TitlePopulator"/&gt; &lt;/entry&gt; 
         &lt;/map&gt;
      &lt;/property&gt;    
      &lt;property name="bindOnNewForm"&gt;&lt;value&gt;true&lt;/value&gt;&lt;/property&gt;
      &lt;property name="commandName"&gt;&lt;value&gt;guestInfoFormBean&lt;/value&gt;&lt;/property&gt;
      <strong>&lt;property name="validator"&gt;&lt;ref bean="name=validator/reservation/GuestInfoFormValidator"/&gt;&lt;/property&gt;</strong>
      &lt;property name="formView"&gt;&lt;value&gt;/reservation/guest_info_form&lt;/value&gt;&lt;/property&gt;
      &lt;property name="successView"&gt;&lt;value&gt;confirmed&lt;/value&gt;&lt;/property&gt;  
       
    &lt;/bean&gt; </span></span></pre>

<p><em>GuestInfoFormValidator</em>.java</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt">public class GuestInfoFormValidator extends BaseValidateAdapter {

   public boolean supports(Class clazz) {
      return GuestInfoFormBean.class.isAssignableFrom(clazz);   
   }

   public void validate(Object obj, Errors errors) {
      final GuestInfoFormBean guestInfoFormBean = (GuestInfoFormBean) obj;

      validateRequiredField(errors, "title", guestInfoFormBean.getTitle(), "label.Title");
      validateRequiredField(errors, "firstName", guestInfoFormBean.getFirstName(), "label.First.Name");
      validateRequiredField(errors, "lastName", guestInfoFormBean.getLastName(), "label.Last.Name");
      validateRequiredField(errors, "address", guestInfoFormBean.getAddress(), "Label.address");
      validateRequiredField(errors, "city", guestInfoFormBean.getCity(), "Label.city");
      validateRequiredField(errors, "stateId", guestInfoFormBean.getFirstName(), "Label.state");
 
      String email = guestInfoFormBean.getEmail();
      if (!StringUtils.isSet(email)) {
          validateRequiredField(errors, "email", email, "label.email");
      } else {
         if (!isValidEmailFormat(email)) {
            errors.reject("error.invalid.email");
         }
      }
   }
}</span></span></span></pre>

<h4><span style="font-size: 10pt">Scope</span></h4>

<p>Spring MVC has four type scopes: singleton, prototype, request, session </p>

<table border="1" style="width: 100%">
  <caption></caption>
  <col>
  <col>
  <tbody>
    <tr>
      <td>singleton</td>
      <td>Scopes a single bean definition to a single object instance per
        Spring IoC container.</td>
    </tr>
    <tr>
      <td>prototype</td>
      <td>Scopes a single bean definition to any number of object instances</td>
    </tr>
    <tr>
      <td>request</td>
      <td>Scopes a single bean definition to the lifecycle of a single HTTP
        request; i.e. each and every HTTP request will have its own instance of
        a bean created off the back of a single bean definition. Only valid in
        the context of a web-aware Spring ApplicationContext</td>
    </tr>
    <tr>
      <td>session</td>
      <td>Scopes a single bean definition to the lifecycle of a HTTP Session.
        Only valid in the context of a web-aware Spring ApplicationContext.</td>
    </tr>
  </tbody>
</table>

<p>GoGWT uses session scope to save and retrive reservation information such as
search criteria, selected hotel etc. </p>

<p>GoGWT Sessoin definition: </p>

<p><em>web.xml</em></p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt">   &lt;filter&gt; 
       &lt;filter-name&gt;requestContextFilter&lt;/filter-name&gt; 
       <strong>&lt;filter-class&gt;org.springframework.web.filter.RequestContextFilter&lt;/filter-class&gt;</strong>
   &lt;/filter&gt;      
   &lt;servlet&gt;
   &lt;servlet-name&gt;booking&lt;/servlet-name&gt;
   &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
   &lt;init-param&gt;
      &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
      &lt;param-value&gt;/WEB-INF/classes/conf/booking-servlet.xml&lt;/param-value&gt;
   &lt;/init-param&gt;
   &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
   &lt;/servlet&gt; </span></span></span></pre>

<p><span><em>booking-servlet.xml</em></span></p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"> &lt;!-- scope beans: session, flash --&gt;
 &lt;import resource="classpath:conf/scopeBeans.xml"/&gt; </span></span></span></pre>

<p><span><em>scopeBeans.xml</em></span></p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 10pt">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd"&gt;

    &lt;!-- ========================= SESSION ============================== --&gt;
    &lt;!-- reservation session manager --&gt;
   <strong>&lt;bean name="reservationSessionManager" class="com.gogwt.app.booking.scopeManager.session.ReservationSessionManager" scope="session"&gt;       
      &lt;aop:scoped-proxy/&gt;
   &lt;/bean&gt;</strong>       
&lt;/beans&gt;</span></span></span></span></pre>

<h4>AOP </h4>

<p>Aspect-oriented programming (<em>AOP</em>)<sup>[2]</sup> is a programming
paradigm which isolates secondary or supporting functions from the main
program's business logic. It aims to increase modularity by allowing the
separation of cross-cutting concerns, forming a basis for aspect-oriented
software development.</p>

<p><span>GoGWT use AOP, after successfully make a reseravation, some functions,
such as sending email etc, are invoked. As sending email is supporting
function, it is suitable to use AOP. </span></p>

<p><em>ReservationAspectJ</em><em></em>.java</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><strong>@Aspect</strong>
public class ReservationAspectJ {
   private static Logger logger = Logger.getLogger(ReservationAspectJ.class);
 
<strong>@Around(value ="execution(*
   com.gogwt.app.booking.businessService.domainService.ReservationBusinessService.confirmReservation(..)) &amp;&amp;
   args(guestInfo, selectHotel, userContext)")</strong>
public ReserveResponseBean newReservationPipelineProcess(
   <strong>final ProceedingJoinPoint joinPoint</strong>, 
   final GuestInfoFormBean guestInfo, final HotelBean selectHotel,
   UserContextBean userContext) throws Throwable {

   logger.debug("==== before point cut ====");

   // 1. join point
   <strong>ReserveResponseBean reservation = (ReserveResponseBean)joinPoint.proceed();</strong>
     
   if (reservation == null) {
     return reservation;
   }
 
   //2. prepare pipeline
   PipelineThreadExecutor pipeLineThread = new PipelineThreadExecutor();
   Map&lt;String, Object&gt; params = new HashMap&lt;String, Object&gt;();
   params.put(RESERVATION, reservation);
   params.put(CONTEXT, userContext);

   // 2.1 add pipeline processor defined in pipeline.xml
   params.put(PIPELINE_PATH, RESERVATION_PIPELINE_NAME);
 
   pipeLineThread.execute(params);

   logger.debug("==== after point cut ====");

   return reservation;
  }
}</span></span></span></pre>

<p>Note: AOP makes compilation longer.</p>

<h4>Multi-Thread and Pipeline</h4>

<p>GoGWT creates separated thread to send email so that the user will get the
reservation response quickly. ThreadPoolExecutor function is the features
provided by Java 1.5 to handle task with pooled threads in order to improved
performance. </p>

<p><em>PipelineThreadExecutor</em><em></em>.java</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt">public class PipelineThreadExecutor {
   private ThreadPoolExecutor threadPoolExecutor;

   private static final int POOL_SIZE = 5;
   private static final int MAX_POOL_SIZE = 5;
   private static final int KEEP_ALIVE_TIME = 500;
   private static final int QUEUE_SIZE = 50;
   private static final int TIMEOUT = 10;

   public PipelineThreadExecutor() {
       threadPoolExecutor = new ThreadPoolExecutor(POOL_SIZE, MAX_POOL_SIZE,
                                    KEEP_ALIVE_TIME, TimeUnit.MILLISECONDS,
                                    new LinkedBlockingQueue&lt;Runnable&gt;(QUEUE_SIZE));
   }


   public void execute(final Map&lt;String, Object&gt; params) {

      threadPoolExecutor.execute(new Runnable() {
         public void run() {
           String path = (String)params.get("pipelinePath");

           ExecutePipeline executePipeline = (ExecutePipeline)BeanLookupService.getBean(path);
           executePipeline.executePipelineProcessors(params);
         }
      });

      //shutdowm
      try {
         threadPoolExecutor.shutdown();
         threadPoolExecutor.awaitTermination(TIMEOUT, TimeUnit.SECONDS);
      }
      catch (Throwable e) {
         logger.fatal("Timeout exceeded getting content.", e);
      }
   }
}</span></span></span></pre>

<p>PipelineThreadExecutor is invoked by AOP class ReservationAspectJ. Inside
execute method, ExecutePipeline is located by BeanLookupService.getBean(path).
Pipeline is created for the cases there are more functions to be executed in
the thread. pipeline.xml is the config file for pipeline, where Processor(s)
are the actual functions to be executed. Here GoGWT defines two dummy
functions: SendCreatedEmailProcessor and ReservationDemoProcessor.</p>

<p><em>pipeline.xml</em></p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt">&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd"&gt;

       &lt;!-- This file will hold all the PIPELINE &amp; PROCESSOR definitions.--&gt;
    
        &lt;!-- ConfirmedReservationProcesssors --&gt;
        &lt;bean name="name=pipeline/reservation/ReservationPipeline"
                 class="com.gogwt.app.booking.pipeline.ExecutePipeline"&gt;
           &lt;property name="processors"&gt;
              &lt;list&gt;
                  &lt;ref bean="name=processor/reservation/SendCreatedEmailProcessor"/&gt;
                  &lt;ref bean="name=processor/reservation/ReservationDemoProcessor"/&gt;
              &lt;/list&gt;
           &lt;/property&gt; 
        &lt;/bean&gt;
        
        &lt;bean name="name=processor/reservation/SendCreatedEmailProcessor"
                 class="com.gogwt.app.booking.pipeline.reservation.SendCreatedEmailProcessor"/&gt;
   
        &lt;bean name="name=processor/reservation/ReservationDemoProcessor"
               class="com.gogwt.app.booking.pipeline.reservation.ReservationDemoProcessor"&gt;
        &lt;/bean&gt;    
&lt;/beans&gt;</span></span></span></pre>

<p>Following shows class diagram and sequence diagram in order to understand
AOP-Thread-Pipeline better.</p>

<p>Class diagram</p>

<p><img alt="AOP class diagram" src="images/UML_aop_pipeline_class.png"
width="1076"></p>

<p></p>

<p>Sequence diagram</p>

<p><img alt="aop sequence" src="images/UML_aop_pipeline_sequence.png"
width="873" height="325"></p>

<p></p>

<h4>Hibernate</h4>

<p>Hibernate<sup>[3]</sup> is an Object/Relational Mapping tool for Java
environments. GoGWT apply Hibernate for database mapping. </p>

<p>GoGWT uses four tables: </p>

<p>Table <em>g_property</em> contains properties data</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">CREATE TABLE `g_property` (
  `id` mediumint(9) NOT NULL auto_increment,
  `name` varchar(100) NOT NULL,
  `property_description` varchar(2000) default NULL,
  `address` varchar(100) NOT NULL,
  `address2` varchar(100) default NULL,
  `city` varchar(40) NOT NULL,
  `state` varchar(40) default NULL,
  `zip_code` varchar(10) default NULL,
  `country` varchar(40) default NULL,
  `lat` decimal(10,6) default NULL,
  `lng` decimal(10,6) default NULL,
  `NumberOfRooms` varchar(10) default NULL,
  `NumberOfSuites` varchar(10) default NULL,
  `NumberOfFloors` varchar(10) default NULL,
  `CheckInTime` varchar(20) default NULL,
  `CheckOutTime` varchar(20) default NULL,
  `HasTennisCourt` varchar(5) default NULL,
  `HasPetsAllowed` varchar(5) default NULL,
  `HasIndoorPool` varchar(5) default NULL,
  `HasOutdoorPool` varchar(5) default NULL,
  `HasKitchen` varchar(5) default NULL,
  PRIMARY KEY  (`id`)
)</span>
</span>  
<span style="background-color:#c0c0c0">Sample data:</span>
105900|Comfort Inn &amp; Suites Atlanta Airport North|The Comfort Inn &amp; Suites Atlanta Airport North is located 5 minutes from Hartsfield International Airport and is near the Chattahoochee River, Chastain Park, Heritage Golf, Lenox Square, Stone Mountain, Georgia Dome, World of Coca Cola, Atlanta Zoo, Six Flags and Lake Lanier.  |1419 Virginia Avenue| |ATLANTA|GA|30337|US|33.659340|-84.435180|247|0|6|3:00 PM   |12:00 PM  | |Y| | | 

111579|Comfort Inn Buckhead North|&lt;b&gt;Location.&lt;/b&gt;&lt;br&gt; &lt;UL&gt;&lt;LI&gt;The Comfort Inn Buckhead North is located in Atlanta, Ga.&lt;/LI&gt; &lt;li&gt;Less than four miles from the Chastain Park Amphitheater&lt;/li&gt;  |5793 Roswell Rd Ne| |ATLANTA|GA|30328|US|33.913360|-84.379030|80|0|5|2 p.m.    |11 a.m.   |Y|Y| | | </span></span></span></pre>

<p></p>

<p>Table <em>g_state</em> contains state list of United States. It has two
language versions, one is English and one is Spanish, to demo the retrival of
multi-language.</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">CREATE TABLE `g_state` (
  `id` mediumint(9) NOT NULL auto_increment,
  `state` varchar(12) NOT NULL default '',
  `languageId` varchar(5) NOT NULL default '',
  `state_name` varchar(100) default NULL,
  PRIMARY KEY  (`id`)
)

<span style="color:#ff8000"><span style="background-color:#ff8040"><span style="background-color:#c0c0c0">Sample Data:</span></span></span>
1|AK|en|ALASKA
8|DC|en|DISTRICT OF COLUMBIA
52|AK|es|ALASKA
59|DC|es|DISTRITO DE COLUMBIA</span></span> </span></span></span></pre>

<p>Table <em>g_keyword</em> contains US city and airport, used for GWT app
suggestion list. </p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">CREATE TABLE `g_keyword` (
  `keyword` varchar(50) NOT NULL default '',
  `lat` decimal(10,6) default NULL,
  `lng` decimal(10,6) default NULL,
  `searchkey` varchar(50) NOT NULL,
  `type` varchar(5) NOT NULL,
   PRIMARY KEY  (`keyword`)
)
CREATE INDEX id_index ON g_keyword(keyword)
CREATE INDEX searchkey_index ON g_keyword(searchkey)

<span style="background-color:#808080"><span style="background-color:#c0c0c0">Sample Data:</span></span>
Tampa, Florida, United States|27.947201|-82.458603|TAMPA FLORIDA UNITED STATES|B
JFK - New York Ny/Newark Kennedy Airport, NY, United States|40.64296|-73.78968|JFK NEW YORK NY/NEWARK KENNEDY AIRPORT NY UNITED STATES|A</span></span></span></span></span></pre>

<p>Table <em>g_reservation</em> is the table record all the reservation.</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">CREATE TABLE `g_reservation` (
  `id` mediumint(9) NOT NULL auto_increment,
  `property_id` int(11) default NULL,
  `first_name` varchar(10) NOT NULL,
  `last_name` varchar(10) NOT NULL,
  `address` varchar(100) NOT NULL,
  `city` varchar(100) NOT NULL,
  `state` varchar(100) NOT NULL,
  `zip` varchar(10) NOT NULL,
  `email` varchar(100) NOT NULL,
  `language_id` varchar(10) NOT NULL,
  `country_id` varchar(10) NOT NULL,
  `create_date` timestamp NOT NULL default CURRENT_TIMESTAMP,
  PRIMARY KEY  (`id`)
)</span></span></span></span></span></pre>

<p>Hibernate startes with hibernate.cfg.xml, where it has following major
sections: Connection setting, Database selection, Cache setting and O/R
Mappings HibernateUtil.java is responsible for creating Hibernate session and
maintant transaction.</p>

<p><em>hibernate.cfg.xml</em></p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">&lt;?xml version='1.0' encoding='utf-8'?&gt;
&lt;!DOCTYPE hibernate-configuration PUBLIC
        "-//Hibernate/Hibernate Configuration DTD 3.0//EN"
        "http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"&gt;

&lt;hibernate-configuration&gt;

    &lt;session-factory&gt;
         
        &lt;property name="connection.datasource"&gt;java:DefaultDS&lt;/property&gt;
           
        &lt;!-- SQL dialect --&gt;
        &lt;property name="dialect"&gt;org.hibernate.dialect.MySQLDialect&lt;/property&gt;
        
        &lt;!-- Enable Hibernate's automatic session context management --&gt;
        &lt;property name="current_session_context_class"&gt;thread&lt;/property&gt;

        &lt;!-- Drop and re-create the database schema on startup --&gt;
        &lt;property name="hbm2ddl.auto"&gt;update&lt;/property&gt;
        
        &lt;!-- Enable the second-level cache  --&gt;
        &lt;property name="cache.provider_class"&gt;net.sf.ehcache.hibernate.EhCacheProvider&lt;/property&gt;
        
        &lt;property name="cache.use_query_cache"&gt;true&lt;/property&gt;
        &lt;property name="cache.use_second_level_cache"&gt;true&lt;/property&gt;
        &lt;property name="hibernate.cache.use_structured_entries"&gt;true&lt;/property&gt;        
        
        &lt;!-- Echo all executed SQL to stdout --&gt;
        &lt;property name="show_sql"&gt;true&lt;/property&gt;
        
        &lt;mapping resource="com/gogwt/app/booking/service/domain/SearchProperty.hbm.xml"/&gt;
        &lt;mapping resource="com/gogwt/app/booking/service/domain/State.hbm.xml"/&gt;
        &lt;mapping resource="com/gogwt/app/booking/service/domain/Reservation.hbm.xml"/&gt;
        &lt;mapping resource="com/gogwt/app/booking/service/domain/Keyword.hbm.xml"/&gt;
        
    &lt;/session-factory&gt;

&lt;/hibernate-configuration&gt;</span></span></span></span></span></pre>

<p>Please note: MySQL with JBoss has problem with connection, for details
perfer to http://forums.mysql.com/read.php?39,373129,389350#msg-389350</p>

<p>HIbernate mapping file contains the relation of Java object and associated
database table. Take keyword as example. table is g_keyword and object is
KeywordBean. Relation is defined with property attributes. lat in KeywordBean
matches lat colume in g_keyword table.</p>

<p><em>keyword.cfg.xml</em></p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
          "http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd"&gt;

&lt;hibernate-mapping package="com.gogwt.app.booking.dto.dataObjects.common"&gt;

    &lt;class name="KeywordBean" table="g_keyword"&gt;
        &lt;id name="keyword" column="keyword"/&gt;        
        &lt;property name="lat"/&gt;
        &lt;property name="lng"/&gt;    
        &lt;property name="searchkey"/&gt; 
        &lt;property name="type"/&gt;          
    &lt;/class&gt;
    
    &lt;sql-query name="selectKeyword" cacheable="true"&gt;
    &lt;![CDATA[
           from KeywordBean where searchkey like :searchkey limit :number ORDER BY keyword ASC
        ]]&gt;
    &lt;/sql-query&gt;
&lt;/hibernate-mapping&gt; </span></span></span></span></span></pre>

<p><strong>JSTL Custom Function</strong></p>

<p>With JSTL, we can create customized function to be accessed within jSP. </p>

<p>Requirments are: </p>
<ul>
  <li>Java class, methods must be static. </li>
  <li>tld definition. </li>
  <li>JSP tag include, use function in JSP</li>
</ul>

<p>GoGWT used custom function to display cutomer and hotel full address.</p>

<p><em>DisplayHelper.java</em></p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">public final class DisplayHelper {
 
  public static String <span style="background-color:#ff8040"><span style="background-color:#ffffff"><span style="background-color:#ff8040">fullAddress</span></span></span>(final HotelBean hotelBean) {
    StringBuilder addressBuilder = new StringBuilder();
    addressBuilder.append(hotelBean.getAddress());
    if (StringUtils.isSet(hotelBean.getAddress2())) {
        addressBuilder.append(" ");
        addressBuilder.append(hotelBean.getAddress2());
    }
    ...
    return addressBuilder.toString();
  }
}<span style="background-color:#ffffff"></span></span></span></span></span></span></pre>

<p><em>goGWTUtils.tld</em> in the folder under WEB-INF</p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;taglib version="2.0" xmlns="http://java.sun.com/xml/ns/j2ee" 
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
        xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee web-jsptaglibrary_2_0.xsd"&gt;
        
  &lt;tlib-version&gt;1.1&lt;/tlib-version&gt;
  &lt;uri&gt;/WEB-INF/goGWTUtils.tld&lt;/uri&gt;
  
  &lt;function&gt;
    &lt;name&gt;<strong>fullHotelAddress</strong>&lt;/name&gt;
    &lt;function-class&gt;com.gogwt.app.booking.gwt.common.helper.DisplayHelper&lt;/function-class&gt;
    &lt;function-signature&gt;String <span style="background-color:#ff8040">fullAddress</span>(com.gogwt.app.booking.dto.dataObjects.common.HotelBean)&lt;/function-signature&gt;
  &lt;/function&gt;
 ...
&lt;/taglib&gt;</span></span></span></span></span></pre>

<p><em>confirmed_reservation.jsp</em></p>
<pre class="programlisting"><span style="font-size: 10pt"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">&lt;%@ taglib uri="/WEB-INF/goGWTUtils.tld" prefix="gogwtutil" %&gt;
  ...
${gogwtutil:<strong>fullHotelAddress</strong>(reservation.selectHotel)}
 ...</span></span></span></span></span></pre>

<p></p>

<h4>Summary</h4>

<h4></h4>

<p>Let's take a quick look at the parts of how to create new page with Spring
MVC.</p>

<p>1. Define controller and mapping name to mappings section.</p>

<p>If page has form, define pojo object and provide entry under controller
definition.</p>

<p>If page has list entry such as dropdown list, check box etc. define
populator function.</p>

<p>2. Create controller Java class extends BaseAbstractController.java </p>

<p>3. If the function is related to database, controller will lookup
domainService and ready to call DAO from domainService. </p>

<p>4. Create hibernate mapping file, the implement the DAO interface with solid
class of Hibernate version.</p>

<p>5. Compile with mvn -DskipTests=true clean install and start server to
test.</p>

<p>Note: you can test DB with unit test. Ignore in this document.</p>

<h1>GWT widget version</h1>

<p>I started GWT with version 1.5.3. After GWT 2.0, Google provide uiBInder
which separate UI from Java. much like separate JSP from Servlet. That is a
good move as from practice we found out that UI developer and Java developer
have different mind set. UI designer thinks more visually, while Java developer
more logically. Also both UI designer and Java developer work on the same Java
file is kind of tough. I created two versions of GWT, one with uiBInder and one
without. Expect different layout approach, all functions are kept as the
same.</p>

<p>Following diagram display how GWT and Spring MVC working together. </p>

<p></p>

<p><ins><img alt="gwt" src="images/spring_gwt_flow.JPG" width="897"
height="1021"></ins> </p>

<p></p>

<p></p>

<h4>Flow of execution:</h4>
Take http://www.gogwt.com/gwtbooking/en-us/gwtreservation as example. 
<ul>
  <li>Once user type in a url such as
    http://www.gogwt.com/gwtbooking/en-us/gwtreservation, Spring
    DispatchServlet will be invoked and URLHandlerInterceptor.java will be
    executed.</li>
  <li>URLHandlerInterceptor will parse the URL to get countryId(us),
    languageId(en) and other env information (such as contextPath, URI etc) ,
    convert env to JSON object, save JSON object to HTTP request variable. Then
    flow will go to the GWTHotelSearchController, the controller is retrieved
    with booking-servlet.xml</li>
  <li>The Controller will handle the request, (optinally validate input,
    session manager, call domain service etc) and forward control to JSP.</li>
  <li>In JSP, 
    <dl>
        <dd>set meta variable for GWT i18n, for example &lt;meta
          name="gwt:property" content="locale=en_us" /&gt;. </dd>
        <dd>assign the request scope JSON object to Javascript variable. GWT
          will read this JSON object later on.</dd>
        <dd>generate html page and return back to browser </dd>
    </dl>
  </li>
  <li>Browser parse generated html and meet nocache.js and then local
    nocache.js from server and GWT engine wiil start on onModuleLoad. </li>
  <li>GWT engine will call page management code generated by compiation of
    defer binding, and create page flow to history listerner.</li>
  <li>Page manager will call page navigation and populator if any.</li>
  <li>Call RPC if any.</li>
  <li>Display resouce bundle content with ResouceBundleWidget.</li>
  <li>The page is randered and displayed to the user.</li>
</ul>

<p><strong>Note:</strong></p>
<ol>
  <li>GWT broswer side is single thread.</li>
  <li>RPC is throught GWTRPCServiceExporter then RPC controller service
    implementation.</li>
  <li>GWTSession is the object to save temp object, the life cycle of it is
    tied with current module.</li>
</ol>

<p></p>

<h4>Integrate GWT with Spring MVC</h4>

<p>GWT Server library (SL)<sup>[4] </sup><sup></sup>provides an easy way to
integrate GWT RPC services to Spring MVC. In theory, every GWT RPC service is a
servelet, instead of creating each individual servlets. With GWT SL library,
RPC can be written with spring managed bean.</p>

<p>Take hotel search RPC as example</p>

<p>The screen shot below shows when the hotelSearch.rpc got called. </p>

<p><img alt="gwt home" src="images/gwt_flow_searchhotel.jpg" width="1076"></p>

<p></p>

<p>1. Define interfaces </p>

<p><em>ReservationProcessService.java and
ReservationProcessServiceAsync.java</em></p>
<pre class="programlisting"><span style="        Management System"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">public interface <strong>ReservationProcessService</strong> extends RemoteService {
   ...
   HotelSearchResponseBean searchHotels(SearchFormBean hotelSearch, UserContextBean userContext) throws AppRemoteException;
   ...
}

public interface ReservationProcessServiceAsync {
   final String HOTEL_SEARCH_SERVICE_URI = "hotelSearch.rpc";
   void  searchHotels(SearchFormBean hotelSearch, UserContextBean userContext, AsyncCallback&lt;HotelSearchResponseBean&gt; callback);
   
   class Util {
      private static ReservationProcessServiceAsync instance;

      public static ReservationProcessServiceAsync searchHotelsAsync() {
        return getInstance(HOTEL_SEARCH_SERVICE_URI);
      }

      private static ReservationProcessServiceAsync getInstance(String uri) {
        if (instance == null) {
           instance = (ReservationProcessServiceAsync) GWT.create(ReservationProcessService.class);
        }
        ServiceDefTarget target = (ServiceDefTarget) instance;
        target.setServiceEntryPoint(GWT.getModuleBaseURL() + uri);
        return instance;
     }
  }
}</span></span></span></span></span></pre>

<p>where Util is the utility class to help the RPC call from clent side.</p>

<p>2. Define Spring managed bean in server side code to implement service
defined above</p>

<p><em>HotelSearchRPCController.java</em></p>
<pre class="programlisting"><span style="   void  searchHotels(SearchFormBean hotelSearch, UserContextBean userContext, AsyncCapublic interface ReservationProcessServiceAsync {"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">public class HotelSearchRPCController extends ReservationProcessServiceAdapter {
   
   public HotelSearchResponseBean searchHotels(SearchFormBean searchFormBean, UserContextBean userContext)
           throws AppRemoteException { 
       
       //1. call domain service, in turn domain service will call hibernate
       ReservationBusinessService reservationBusinessService = LookupBusinessService.getReservationBusinessService();
       HotelSearchResponseBean hotelSearchResponse = reservationBusinessService.findHotelsWithLocation(searchFormBean);

       //2. set request/response to session
       SessionBeanLookupService.getReservationSessionManager().getReservationContainerBean().setStatus(ProcessStatusEnum.SEARCH_RESULT);
       SessionBeanLookupService.getReservationSessionManager().getReservationContainerBean().setHotelSearchRequest(searchFormBean);
       SessionBeanLookupService.getReservationSessionManager().getReservationContainerBean().setHotelSearchResponse(hotelSearchResponse);
   }
}

public abstract class ReservationProcessServiceAdapter extends BaseService implements <strong>ReservationProcessService</strong> {
  ...
}</span></span></span></span></span></pre>

<p>3. Spring RPC config. </p>

<p>3.1 define servlet url-pattern in web.xml</p>

<p><em>web.xml</em>l</p>
<pre class="programlisting"><span style="   void  searchHotels(SearchFormBean hotelSearch, UserContextBean userContext, AsyncCapublic interface ReservationProcessServiceAsync {"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">  ... 
  &lt;servlet-mapping&gt;
     &lt;servlet-name&gt;booking&lt;/servlet-name&gt;
     &lt;url-pattern&gt;*.rpc&lt;/url-pattern&gt;
   &lt;/servlet-mapping&gt;
  ...</span></span></span></span></span></pre>

<p>3.2 rpcConifg.xml is included by main Srping config file of
booking-servlet.xml and dedicates for defining RPC</p>

<p><em>rpcConfig.xmll</em></p>
<pre class="programlisting"><span style="   void  searchHotels(SearchFormBean hotelSearch, UserContextBean userContext, AsyncCapublic interface ReservationProcessServiceAsync {"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt"> &lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd"&gt;

  &lt;!-- ======== Service End Points ========== --&gt;
  &lt;bean name="name=rpc/reservation/HotelSearchEndPoint" class="com.gogwt.app.booking.rpc.services.reservation.HotelSearchRPCController"/&gt;

  &lt;!-- ======== GWT-Spring Integration Assignments ======= --&gt; 
  &lt;bean name="name=rpc/reservation/HotelSearchControllerExport" class="org.gwtwidgets.server.spring.GWTRPCServiceExporter"&gt;
     &lt;property name="service" ref="name=rpc/reservation/HotelSearchEndPoint" /&gt;
  &lt;/bean

    &lt;!-- =======================================================================
    URL Handler Mapping
  ============================================================================ --&gt;  
   &lt;bean name="rpcURLMapping" class="org.springframework.web.servlet.handler.SimpleUrlHandlerMapping"&gt;
     &lt;property name="mappings"&gt;
        &lt;props&gt;
            &lt;prop key="/**/suggestiveText.rpc/**/"&gt;name=rpc/reservation/HotelSearchControllerExport&lt;/prop&gt;
            <strong>&lt;prop key="/**/hotelSearch.rpc/**/"&gt;name=rpc/reservation/HotelSearchControllerExport&lt;/prop&gt;</strong> 
            &lt;prop key="/**/reserveHotel.rpc/**/"&gt;name=rpc/reservation/HotelReserveControllerExport&lt;/prop&gt; 
            &lt;prop key="/**/reservationSession.rpc/**/"&gt;name=rpc/reservation/SessionRetrievalControllerExport&lt;/prop&gt; 
            &lt;prop key="/**/gethoteldetail.rpc/**/"&gt;name=rpc/hoteldetail/HotelDetailControllerExport&lt;/prop&gt;                         
        &lt;/props&gt;
      &lt;/property&gt;
   &lt;/bean&gt;        
&lt;/beans&gt;</span></span></span></span></span></pre>

<p>Note: There is not URL intrecepter required for the RPC, as UserContextBean
is used for passing enviroment values such as languageId and countryId. </p>

<p>4. Invoke hotelSearch.rpc</p>

<p>GoGWT created RPC proxy in order to put additoinal function to the RPC
request, such as timedout if RPC does not return in preset time, and/or cache
the RPC result. </p>
<span style="font-size: 9pt">With current release, those functions are not
added in order to simpilfy code base. </span>

<p><em>HomeFormEntry.java</em>l</p>
<pre class="programlisting"><span style="   void  searchHotels(SearchFormBean hotelSearch, UserContextBean userContext, AsyncCapublic interface ReservationProcessServiceAsync {"><span style="font-size: 10pt"><span style="font-size: 11pt"><span style="font-size: 8pt"><span style="font-size: 10pt">public class HomeFormEntry  implements ClickHandler, SelectionHandler,  RPCProxyInterface&lt;HotelSearchResponseBean&gt; {
   public void onClick(ClickEvent eventWidget) {
       // validate
       ...
       //rpc call.
       RPCReservationProxy.getInstance().searchHotels(request,
               GWTExtClientUtils.getUserContext(), new CommandBean(), this);
   }

   public void handleRPCSuccess(HotelSearchResponseBean hotelSearchResponse, CommandBean command) {
       // if no result
       if (hotelSearchResponse == null || !hotelSearchResponse.hasSearchResult()) {
          ErrorPanel.getInstance().displayError(tags.error_no_search_result());
          return;
       }
 
       // save result to session
       GWTSession.getCurrentReservationContainer().setHotelSearchResponse(hotelSearchResponse);

       //  go to hotelsearchresult page
       GWTExtClientUtils.forward(VIEW_SEARCH_RESULT);
   }

   public void handleRPCError(Throwable caught, CommandBean command) {
        if (caught instanceof InvalidateGeocodeException) {         
            ErrorPanel.getInstance().displayError(tags.error_invalid_geocode());
            return;
        }
        
        //generic error
        ErrorPanel.getInstance().displayError(tags.error_generic_message());
    }   
}</span></span></span></span></span></pre>

<p>Where handleRPCSuccess is callback method for success and handleRPCError is
callback method for failure.</p>

<p><em>Class diagram</em></p>

<p><img alt="hotel search" src="images/gogwt_hotel_search_rpc.png"
width="1218"></p>

<p></p>

<p><strong>Segmentation and Responsibility</strong></p>

<p>GoGWT apply following pattern for RPC request.</p>

<p>GWT client -&gt; RPC Proxy -&gt; RPCController -&gt; DomainService -&gt; DAO
(Hibernate)</p>

<p></p>

<h3>Page(Token) navigation </h3>

<p></p>

<p></p>

<h3>Reference:</h3>

<p>1. http://code.google.com/webtoolkit/overview.html</p>

<p>2. http://en.wikipedia.org/wiki/Aspect-oriented_programming</p>

<p>3.
http://docs.jboss.org/hibernate/stable/core/reference/en/html/preface.html</p>

<p>4. http://gwt-widget.sourceforge.net/</p>

<p></p>
</div>
</div>

<p>----------------------------------------------------------</p>

<p>=====================================================================</p>

<p>===================================================================== </p>
</div>
</div>
</body>
</html>
